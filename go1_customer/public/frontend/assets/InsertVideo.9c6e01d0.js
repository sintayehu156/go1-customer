var g=(o,e,t)=>new Promise((p,i)=>{var s=l=>{try{a(t.next(l))}catch(r){i(r)}},d=l=>{try{a(t.throw(l))}catch(r){i(r)}},a=l=>l.done?p(l.value):Promise.resolve(l.value).then(s,d);a((t=t.apply(o,e)).next())});import{c as S}from"./ListView.0c88aa81.js";import{D as C}from"./Dialog.7d7f87d0.js";import{_ as v,o as f,f as m,n as D,L as y,R as F,S as k,e as _,g as u,w as n,p as c,z as N,y as U,B as w,F as E}from"./vendor.72004f8a.js";import"./index.feff435d.js";class L{constructor(){this.listeners={},this.failed=!1}on(e,t){this.listeners[e]=this.listeners[e]||[],this.listeners[e].push(t)}trigger(e,t){(this.listeners[e]||[]).forEach(i=>{i.call(this,t)})}upload(e,t){return new Promise((p,i)=>{let s=new XMLHttpRequest;s.upload.addEventListener("loadstart",()=>{this.trigger("start")}),s.upload.addEventListener("progress",l=>{l.lengthComputable&&this.trigger("progress",{uploaded:l.loaded,total:l.total})}),s.upload.addEventListener("load",()=>{this.trigger("finish")}),s.addEventListener("error",()=>{this.trigger("error"),i()}),s.onreadystatechange=()=>{if(s.readyState==XMLHttpRequest.DONE){let l;if(s.status===200){let r=null;try{r=JSON.parse(s.responseText)}catch(V){r=s.responseText}let h=r.message||r;p(h)}else if(s.status===403)l=JSON.parse(s.responseText);else{this.failed=!0;try{l=JSON.parse(s.responseText)}catch(r){}}l&&l.exc&&console.error(JSON.parse(l.exc)[0]),i(l)}};const d=t.upload_endpoint||"/api/method/upload_file";s.open("POST",d,!0),s.setRequestHeader("Accept","application/json"),window.csrf_token&&window.csrf_token!=="{{ csrf_token }}"&&s.setRequestHeader("X-Frappe-CSRF-Token",window.csrf_token);let a=new FormData;e&&a.append("file",e,e.name),a.append("is_private",t.private?"1":"0"),a.append("folder",t.folder||"Home"),t.file_url&&a.append("file_url",t.file_url),t.doctype&&a.append("doctype",t.doctype),t.docname&&a.append("docname",t.docname),t.fieldname&&a.append("fieldname",t.fieldname),t.method&&a.append("method",t.method),t.type&&a.append("type",t.type),s.send(a)})}}const R={name:"FileUploader",props:["fileTypes","uploadArgs","validateFile"],data(){return{uploader:null,uploading:!1,uploaded:0,error:null,message:"",total:0,file:null,finishedUploading:!1}},computed:{progress(){let o=Math.floor(this.uploaded/this.total*100);return isNaN(o)?0:o},success(){return this.finishedUploading&&!this.error}},methods:{inputRef(){return this.$refs.input},openFileSelector(){this.$refs.input.click()},onFileAdd(o){return g(this,null,function*(){if(this.error=null,this.file=o.target.files[0],this.file&&this.validateFile)try{let e=yield this.validateFile(this.file);e&&(this.error=e)}catch(e){this.error=e}this.error||this.uploadFile(this.file)})},uploadFile(o){return g(this,null,function*(){this.error=null,this.uploaded=0,this.total=0,this.uploader=new L,this.uploader.on("start",()=>{this.uploading=!0}),this.uploader.on("progress",e=>{this.uploaded=e.uploaded,this.total=e.total}),this.uploader.on("error",()=>{this.uploading=!1,this.error="Error Uploading File"}),this.uploader.on("finish",()=>{this.uploading=!1,this.finishedUploading=!0}),this.uploader.upload(o,this.uploadArgs||{}).then(e=>{this.$emit("success",e)}).catch(e=>{this.uploading=!1;let t="Error Uploading File";(e==null?void 0:e._server_messages)?t=JSON.parse(JSON.parse(e._server_messages)[0]).message:(e==null?void 0:e.exc)&&(t=JSON.parse(e.exc)[0].split(`
`).slice(-2,-1)[0]),this.error=t,this.$emit("failure",e)})})}},expose:["inputRef"]},A=["accept"];function O(o,e,t,p,i,s){return f(),m("div",null,[D("input",{ref:"input",type:"file",accept:t.fileTypes,class:"hidden",onChange:e[0]||(e[0]=(...d)=>s.onFileAdd&&s.onFileAdd(...d))},null,40,A),y(o.$slots,"default",F(k({file:i.file,uploading:i.uploading,progress:s.progress,uploaded:i.uploaded,message:i.message,error:i.error,total:i.total,success:s.success,openFileSelector:s.openFileSelector})))])}var T=v(R,[["render",O]]);const B={name:"InsertImage",props:["editor"],expose:["openDialog"],data(){return{addVideoDialog:{url:"",file:null,show:!1}}},components:{Button:S,Dialog:C,FileUploader:T},methods:{openDialog(){this.addVideoDialog.show=!0},onVideoSelect(o){let e=o.target.files[0];!e||(this.addVideoDialog.file=e)},addVideo(o){this.editor.chain().focus().insertContent(`<video src="${o}"></video>`).run(),this.reset()},reset(){this.addVideoDialog=this.$options.data().addVideoDialog}}},J={class:"flex items-center space-x-2"},H=["src"];function j(o,e,t,p,i,s){const d=_("Button"),a=_("FileUploader"),l=_("Dialog");return f(),m(E,null,[y(o.$slots,"default",F(k({onClick:s.openDialog}))),u(l,{options:{title:"Add Video"},modelValue:i.addVideoDialog.show,"onUpdate:modelValue":e[2]||(e[2]=r=>i.addVideoDialog.show=r),onAfterLeave:s.reset},{"body-content":n(()=>[u(a,{"file-types":"video/*",onSuccess:e[0]||(e[0]=r=>i.addVideoDialog.url=r.file_url)},{default:n(({file:r,progress:h,uploading:V,openFileSelector:x})=>[D("div",J,[u(d,{onClick:x},{default:n(()=>[c(N(V?`Uploading ${h}%`:i.addVideoDialog.url?"Change Video":"Upload Video"),1)]),_:2},1032,["onClick"]),i.addVideoDialog.url?(f(),U(d,{key:0,onClick:()=>{i.addVideoDialog.url=null,i.addVideoDialog.file=null}},{default:n(()=>e[3]||(e[3]=[c(" Remove ")])),_:2},1032,["onClick"])):w("",!0)])]),_:1}),i.addVideoDialog.url?(f(),m("video",{key:0,src:i.addVideoDialog.url,class:"mt-2 w-full rounded-lg",type:"video/mp4",controls:""},null,8,H)):w("",!0)]),actions:n(()=>[u(d,{variant:"solid",onClick:e[1]||(e[1]=r=>s.addVideo(i.addVideoDialog.url))},{default:n(()=>e[4]||(e[4]=[c(" Insert Video ")])),_:1}),u(d,{onClick:s.reset},{default:n(()=>e[5]||(e[5]=[c("Cancel")])),_:1},8,["onClick"])]),_:1},8,["modelValue","onAfterLeave"])],64)}var b=v(B,[["render",j]]);export{b as default};
